class MaxStack {
    class DLNode {
        int val;
        boolean flag;
        DLNode pre, post;
        public DLNode(int val) {
            this.val = val;
        }
        public DLNode() {
            
        }
    }
    
    DLNode head, tail;
    TreeMap<Integer, LinkedList<DLNode>> map;
    public MaxStack() {
        head = new DLNode();
        tail = new DLNode();
        head.flag = true;
        tail.flag = true;
        head.post = tail;
        tail.pre = head;
        map = new TreeMap();
    }

    public void insertAtHead(DLNode node) {
        node.pre = head;
        node.post = head.post;
        head.post.pre = node;
        head.post = node;
    }
    
    public void delete(DLNode node) {
        DLNode pre = node.pre;
        DLNode post = node.post;
        pre.post = post;
        post.pre = pre;
    }
    
    public DLNode popHead() {
        DLNode ret = head.post;
        delete(ret);
        return ret;
    }
      
    //O(logn) time and O(1) space
    public void push(int x) {
        DLNode node = new DLNode(x);
        insertAtHead(node);
        map.putIfAbsent(x, new LinkedList());
        map.get(x).add(node);
    }

    //O(logn) time and O(1) space
    public int pop() {
        if(head.post.flag) return 0;
        DLNode pop = popHead();
        LinkedList<DLNode> list = map.get(pop.val);
        list.removeLast();
        if(list.isEmpty()) map.remove(pop.val);
        else map.put(pop.val, list);
        return pop.val;
    }

    //O(1) time and space   
    public int top() {
        return head.post.val;
    }

    //O(logn) time and O(1) space  
    public int peekMax() {
        int max = map.lastKey();
        return max;
    }

    //O(logn) time and O(1) space  
    public int popMax() {
        if(head.post.flag) return 0;
        int max = map.lastKey();
        LinkedList<DLNode> list = map.get(max);
        DLNode rem = list.getLast();
        list.removeLast();
        delete(rem);
        if(list.isEmpty()) map.remove(max);
        else map.put(max, list);
        return max;
    }
}
